<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesli Asistan - Restaurant App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #2c3e50;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(30px);
            border-radius: 32px;
            box-shadow: 0 32px 64px rgba(0,0,0,0.2),
                        0 0 0 1px rgba(255, 255, 255, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            width: 95%;
            max-width: 900px;
            height: 650px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideInUp 0.8s ease-out, containerGlow 3s ease-in-out infinite alternate;
            position: relative;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 32px;
            pointer-events: none;
        }
        
        @keyframes containerGlow {
            0% { box-shadow: 0 32px 64px rgba(0,0,0,0.2), 0 0 0 1px rgba(255, 255, 255, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.3); }
            100% { box-shadow: 0 32px 64px rgba(0,0,0,0.25), 0 0 20px rgba(102, 126, 234, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.4); }
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
            position: relative;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            pointer-events: none;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .back-btn {
            position: absolute;
            left: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .restaurant-info {
            margin-top: 10px;
            font-size: 14px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            animation: messageSlideIn 0.4s ease-out;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message.assistant {
            justify-content: flex-start;
        }
        
        .message-content {
            max-width: 75%;
            padding: 1rem 1.2rem;
            border-radius: 20px;
            word-wrap: break-word;
            line-height: 1.5;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .message-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 20px;
            pointer-events: none;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, #007bff, #0056b3, #6f42c1);
            background-size: 200% 200%;
            animation: messageGradient 6s ease infinite;
            color: white;
            border-bottom-right-radius: 5px;
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
        }
        
        .message.assistant .message-content {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,249,250,0.8));
            color: #2c3e50;
            border: 1px solid rgba(255,255,255,0.3);
            border-bottom-left-radius: 5px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        @keyframes messageGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        .typing-indicator {
            display: none;
            padding: 1rem 1.2rem;
            background: transparent;
            max-width: 70%;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { 
                transform: translateY(0);
                opacity: 0.4;
            }
            30% { 
                transform: translateY(-8px);
                opacity: 1;
            }
        }
        
        .controls {
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0,0,0,0.1);
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .voice-btn {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .voice-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .voice-btn:hover::before {
            left: 100%;
        }
        
        .voice-btn.start {
            background: linear-gradient(135deg, #28a745, #20c997, #17a2b8);
            background-size: 200% 200%;
            animation: voiceGradient 4s ease infinite;
            color: white;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .voice-btn.start::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.6s ease;
        }
        
        .voice-btn.start:hover {
            background: linear-gradient(135deg, #20c997, #17a2b8, #6f42c1);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 35px rgba(40, 167, 69, 0.5);
        }
        
        .voice-btn.start:hover::after {
            width: 300px;
            height: 300px;
        }
        
        .voice-btn.stop {
            background: linear-gradient(135deg, #dc3545, #e83e8c, #fd7e14);
            background-size: 200% 200%;
            animation: voiceGradient 4s ease infinite;
            color: white;
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .voice-btn.stop::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.6s ease;
        }
        
        .voice-btn.stop:hover {
            background: linear-gradient(135deg, #e83e8c, #fd7e14, #ffc107);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 35px rgba(220, 53, 69, 0.5);
        }
        
        .voice-btn.stop:hover::after {
            width: 300px;
            height: 300px;
        }
        
        @keyframes voiceGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .status {
            text-align: center;
            padding: 1rem;
            font-size: 0.9rem;
            color: #666;
            background: rgba(248, 249, 250, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.1);
            font-weight: 500;
        }
        
        .status.connected {
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
        
        .status.error {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }
        
        .alert {
            padding: 10px 20px;
            margin: 10px 20px;
            border-radius: 5px;
            display: none;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message-input-container {
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        .input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .text-input {
            flex: 1;
            padding: 0.8rem 1.2rem;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            outline: none;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            transition: all 0.3s ease;
            color: #2c3e50;
            position: relative;
        }
        
        .text-input::placeholder {
            color: rgba(44, 62, 80, 0.6);
        }
        
        .text-input:focus {
            border-color: rgba(0, 123, 255, 0.5);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2), 0 8px 25px rgba(0, 123, 255, 0.1);
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .send-btn {
            padding: 0.8rem 1.5rem;
            background: linear-gradient(135deg, #007bff, #0056b3, #6f42c1);
            background-size: 200% 200%;
            animation: sendGradient 5s ease infinite;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .send-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .send-btn:hover {
            background: linear-gradient(135deg, #0056b3, #6f42c1, #e83e8c);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 30px rgba(0, 123, 255, 0.5);
        }
        
        .send-btn:hover::before {
            left: 100%;
        }
        
        @keyframes sendGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @media (max-width: 768px) {
            .container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
                max-width: none;
            }
            
            .header {
                padding: 1rem 1.5rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .back-btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            
            .chat-messages {
                padding: 1rem;
            }
            
            .message-content {
                max-width: 85%;
                padding: 0.8rem 1rem;
            }
            
            .message-input-container {
                padding: 1rem;
            }
            
            .controls {
                padding: 1rem;
            }
            
            .voice-btn {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }
            
            .input-group {
                gap: 0.5rem;
            }
            
            .text-input {
                padding: 0.7rem 1rem;
                font-size: 0.85rem;
            }
            
            .send-btn {
                padding: 0.7rem 1.2rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="customer.html" class="back-btn">â† Geri</a>
            <h1>ğŸ¤ Sesli Asistan</h1>
            <div class="restaurant-info" id="restaurantInfo">RestoranÄ±nÄ±zla konuÅŸun ve sipariÅŸ verin</div>
        </div>
        
        <div id="alert" class="alert"></div>
        
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-content">
                        <div>Merhaba! Size nasÄ±l yardÄ±mcÄ± olabilirim? SipariÅŸ vermek ister misiniz?</div>
                        <div class="message-time" id="welcomeTime"></div>
                    </div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
        
        <div class="message-input-container">
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." 
                       class="text-input" onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()" class="send-btn">
                    GÃ¶nder
                </button>
            </div>
        </div>
        
        <div class="controls">
            <button id="voiceButton" class="voice-btn start">
                <span>ğŸ¤</span>
                <span>KonuÅŸmaya BaÅŸla</span>
            </button>
        </div>
        
        <div class="status" id="status">HazÄ±r</div>
    </div>

    <script>
        /**
         * Sesli Asistan - Realtime API Sistemi
         * 
         * Ã–zellikler:
         * - OpenAI Realtime API entegrasyonu
         * - Sesli komut tanÄ±ma  
         * - Text-to-Speech
         * - AkÄ±llÄ± fallback sistemi
         * - Sepet yÃ¶netimi
         * - SipariÅŸ iÅŸlemleri
         */
        
        // Sesler yÃ¼klenene kadar bekle
        window.speechSynthesis.onvoiceschanged = () => {
            const voices = window.speechSynthesis.getVoices();
            console.log('ğŸ”Š Sesler yÃ¼klendi:', voices.length);
            
            const turkishVoices = voices.filter(v => v.lang.includes('tr'));
            if (turkishVoices.length > 0) {
                console.log('ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e sesler:', turkishVoices.map(v => v.name));
            } else {
                console.log('âš ï¸ TÃ¼rkÃ§e ses bulunamadÄ±!');
            }
        };

        // Sayfa yÃ¼klendiÄŸinde sesleri tetikle
        if (window.speechSynthesis.getVoices().length === 0) {
            window.speechSynthesis.getVoices();
        }

        // Ana deÄŸiÅŸkenler
        const API_BASE = 'http://127.0.0.1:8000';
        const chatMessages = document.getElementById('chatMessages');
        const voiceButton = document.getElementById('voiceButton');
        const statusDiv = document.getElementById('status');
        const alertDiv = document.getElementById('alert');
        const typingIndicator = document.getElementById('typingIndicator');
        const restaurantInfo = document.getElementById('restaurantInfo');

        let recognition;
        let websocket;
        let currentRestaurantId = null;
        let authToken = localStorage.getItem('auth_token');
        let currentUser = null;
        let selectedRestaurant = null;
        let isSpeaking = false;
        let isListening = false;
        let cart = [];

        // URL'den restoran ID'sini al
        const urlParams = new URLSearchParams(window.location.search);
        currentRestaurantId = urlParams.get('restaurant_id');

        if (!currentRestaurantId) {
            showAlert('Restoran seÃ§ilmedi. LÃ¼tfen mÃ¼ÅŸteri panelinden bir restoran seÃ§in.', 'error');
            setTimeout(() => window.location.href = 'customer.html', 3000);
        }

        /**
         * Alert gÃ¶sterme sistemi
         */
        function showAlert(message, type = 'error') {
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        /**
         * Status gÃ¶sterme sistemi
         */
        function showStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        /**
         * Typing indicator kontrol sistemi
         */
        let typingTimeout = null;

        function showTyping() {
            typingIndicator.style.display = 'block';
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // 3 saniye sonra otomatik kapat
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                console.log('â° Typing timeout - otomatik kapatÄ±lÄ±yor');
                hideTyping();
            }, 3000);
        }

        function hideTyping() {
            typingIndicator.style.display = 'none';
            clearTimeout(typingTimeout);
        }

        /**
         * Text-to-Speech sistemi
         */
        function speak(text) {
            console.log('ğŸ—£ï¸ TTS baÅŸlatÄ±lÄ±yor:', text.substring(0, 50) + '...');
            
            // Mikrofonu kapat
            if (recognition && isListening) {
                recognition.stop();
                isListening = false;
                resetVoiceButton();
            }
            
            isSpeaking = true;
            showStatus('Asistan konuÅŸuyor...', 'info');
            
            // Metni temizle
            let cleanText = text
                .replace(/[ğŸ½ï¸ğŸ¥¤ğŸ°ğŸ±ğŸ“‹âŒâœ…ğŸ“â€¢()]/g, '')
                .replace(/<br>/g, ' ')
                .replace(/\n/g, ' ')
                .replace(/\s+/g, ' ')
                .replace(/â‚º/g, 'lira')
                .replace(/TL/g, 'TÃ¼rk LirasÄ±')
                .trim();
            
            if (!cleanText) {
                isSpeaking = false;
                showStatus('HazÄ±r', 'info');
                return;
            }
            
            // TTS'i tamamen iptal et Ã¶nce
            window.speechSynthesis.cancel();
            
            // Daha uzun bekleme ile TTS baÅŸlat
            setTimeout(() => {
                if (!isSpeaking) return; // Iptal edildiyse baÅŸlatma
                
                const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'tr-TR';
                utterance.rate = 0.9; // Biraz daha hÄ±zlÄ±
            utterance.pitch = 1;
            utterance.volume = 1;
                
                const voices = window.speechSynthesis.getVoices();
                const turkishVoice = voices.find(voice => voice.lang.includes('tr'));
                if (turkishVoice) {
                    utterance.voice = turkishVoice;
                } else {
                    utterance.lang = 'en-US';
                }
            
            utterance.onstart = () => {
                    console.log('ğŸ”Š TTS baÅŸladÄ±');
                    isSpeaking = true;
                showStatus('Asistan konuÅŸuyor...', 'info');
            };
            
            utterance.onend = () => {
                    console.log('âœ… TTS tamamlandÄ±');
                isSpeaking = false;
                showStatus('HazÄ±r', 'info');
                };
                
                utterance.onerror = (event) => {
                    console.log('âŒ TTS hatasÄ±:', event.error);
                    if (event.error !== 'interrupted') {
                        // Interrupted dÄ±ÅŸÄ±ndaki hatalar iÃ§in tekrar dene
                setTimeout(() => {
                            if (isSpeaking) {
                                window.speechSynthesis.speak(utterance);
                            }
                        }, 500);
                    } else {
                isSpeaking = false;
                showStatus('HazÄ±r', 'info');
                    }
            };
            
                try {
            window.speechSynthesis.speak(utterance);
                    console.log('ğŸ¯ TTS baÅŸlatÄ±ldÄ±');
                } catch (error) {
                    console.error('âŒ TTS baÅŸlatma hatasÄ±:', error);
                    isSpeaking = false;
                    showStatus('HazÄ±r', 'info');
                }
            }, 200); // 200ms bekleme
        }

        /**
         * KullanÄ±cÄ± bilgilerini getir
         */
        async function fetchCurrentUser() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    currentUser = await response.json();
                    console.log('ğŸ‘¤ KullanÄ±cÄ±:', currentUser.username, currentUser.role);
                } else {
                    throw new Error('KullanÄ±cÄ± bilgileri alÄ±namadÄ±');
                }
            } catch (error) {
                console.error('âŒ KullanÄ±cÄ± hatasÄ±:', error);
                showAlert('GiriÅŸ yapmanÄ±z gerekiyor!', 'error');
                setTimeout(() => window.location.href = 'login.html', 2000);
            }
        }

        /**
         * Restoran bilgilerini getir
         */
        async function fetchSelectedRestaurant(restaurantId) {
            try {
                const response = await fetch(`${API_BASE}/restaurants/${restaurantId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    selectedRestaurant = await response.json();
                    restaurantInfo.innerHTML = `
                        <strong>${selectedRestaurant.name}</strong><br>
                        <small>${selectedRestaurant.address || 'Adres bilgisi yok'}</small><br>
                        <small>ğŸ“ ${selectedRestaurant.phone || 'Telefon bilgisi yok'}</small>
                    `;
                    console.log('ğŸª Restoran:', selectedRestaurant.name);
                } else {
                    throw new Error('Restoran bilgileri alÄ±namadÄ±');
                }
            } catch (error) {
                console.error('âŒ Restoran hatasÄ±:', error);
                showAlert('Restoran bilgileri alÄ±namadÄ±.', 'error');
            }
        }

        /**
         * WebSocket baÄŸlantÄ± sistemi - Temiz ve Stabil
         */
        function connectWebSocket() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                return;
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//127.0.0.1:8000/realtime`;
            
            try {
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function() {
                    showStatus('ğŸ¤ Realtime API baÄŸlandÄ±', 'connected');
                };
                
                websocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'function_result') {
                            console.log('ğŸ”§ Function result:', data.result);
                        } else if (data.type === 'menu_data') {
                            console.log('ğŸ“‹ MenÃ¼ verisi alÄ±ndÄ±:', data.data);
                        } else if (data.type === 'error') {
                            console.error('âŒ OpenAI Error:', data.error);
                        }
                        
                        handleRealtimeResponse(data);
                    } catch (error) {
                        console.error('âŒ JSON parse hatasÄ±:', error);
                        console.log('ğŸ”„ Fallback: Local error handling');
                        hideTyping();
                    }
                };
                
                websocket.onclose = function(event) {
                    console.log('ğŸ”Œ WebSocket kapandÄ±:', event.code);
                    hideTyping();
                    showStatus('BaÄŸlantÄ± kesildi...', 'error');
                    
                    // 3 saniye sonra yeniden baÄŸlan
                    setTimeout(connectWebSocket, 3000);
                };
                
                websocket.onerror = function(error) {
                    console.error('âŒ WebSocket hatasÄ±:', error);
                    hideTyping();
                    showStatus('BaÄŸlantÄ± hatasÄ±', 'error');
                };
                
            } catch (error) {
                console.error('âŒ WebSocket oluÅŸturma hatasÄ±:', error);
                showStatus('BaÄŸlantÄ± kurulamadÄ±', 'error');
            }
        }

        /**
         * Realtime API response'larÄ±nÄ± iÅŸle
         */
        function handleRealtimeResponse(data) {
            console.log('ğŸ“¥ Realtime response:', data.type || 'unknown');
            hideTyping();
            
            // Timeout sistemi kaldÄ±rÄ±ldÄ±
            
            // DOÄRU: Function result handling
            if (data.type === 'function_result' && data.result) {
                console.log('ğŸ”§ Function result:', data.result);
                
                if (data.result.success) {
                    // EÄŸer menÃ¼ getirildiyse, menÃ¼ iÃ§eriÄŸini gÃ¶ster
                    if (data.result.data && Array.isArray(data.result.data)) {
                        // MenÃ¼ verisi kontrolÃ¼ - kategoriler var mÄ±?
                        if (data.result.data.length > 0 && data.result.data[0].name && data.result.data[0].items) {
                            displayMenu(data.result.data);
                        } 
                        // Sepet verisi - item_name field'Ä± var mÄ±?
                        else if (data.result.data.length > 0 && data.result.data[0].item_name) {
                            displayCart(data.result.data);
                        }
                    } else if (data.result.message) {
                        addMessage('assistant', data.result.message);
                        speak(data.result.message);
                    }
                } else {
                    addMessage('assistant', data.result.message || 'Bir hata oluÅŸtu');
                    speak(data.result.message || 'Bir hata oluÅŸtu');
                }
                return;
            }
            
            // MenÃ¼ verisi ayrÄ± mesaj olarak gelirse - KALDIRILDI (duplicate displayMenu Ã§aÄŸrÄ±sÄ±)
            // if (data.type === 'menu_data' && data.data) {
            //     console.log('ğŸ“‹ MenÃ¼ verisi alÄ±ndÄ±:', data.data);
            //     displayMenu(data.data);
            //     return;
            // }
            
            // Error handling - sadece log
            if (data.type === 'error') {
                console.log('âŒ OpenAI Error:', data.error);
                addMessage('assistant', 'ÃœzgÃ¼nÃ¼m, bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.');
                return;
            }
            
            // Text response handling
            if (data.type === 'response.text.delta' && data.delta) {
                addMessage('assistant', data.delta);
                speak(data.delta);
                return;
            }
            
            // Response completed
            if (data.type === 'response_completed') {
                console.log('âœ… Response completed');
                return;
            }
            
            // Failed response - sadece log
            if (data.type === 'response.done' && data.response?.status === 'failed') {
                console.log('âŒ Response failed');
                addMessage('assistant', 'ÃœzgÃ¼nÃ¼m, bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.');
                return;
            }
            
            // Normal response.done - OpenAI function call sistemi
            if (data.type === 'response.done') {
                console.log('âœ… Response completed');
                return;
            }

            // Function call handling
            if (data.type === 'conversation.item.created' && data.item && data.item.role === 'assistant') {
                const content = data.item.content[0];
                
                // Function call kontrolÃ¼ - Backend'de iÅŸleniyor, sadece mesaj gÃ¶ster
                if (content && content.type === 'function_call') {
                    console.log('ğŸ”§ Function call tespit edildi:', content.name);
                    // Backend function call'Ä± iÅŸleyecek, frontend sadece mesaj gÃ¶sterecek
                    return;
                }
                
                // Normal text response
                if (content && content.output_text) {
                    // "BaÄŸlantÄ± kuruluyor" mesajlarÄ±nÄ± filtrele
                    if (content.output_text.includes('BaÄŸlantÄ±') || content.output_text.includes('bekleyin')) {
                        console.log('ğŸš« BaÄŸlantÄ± mesajÄ± filtrelendi');
                        // Function call sistemi kullanÄ±lÄ±yor, fallback gerekmiyor
                        return;
                    }
                    
                    addMessage('assistant', content.output_text);
                    speak(content.output_text);
                }
            }
            
            // Error handling
            if (data.type === 'error') {
                console.log('âŒ Realtime error:', data.error?.message);
                // Function call sistemi kullanÄ±lÄ±yor, fallback gerekmiyor
            }
        }

        /**
         * Son kullanÄ±cÄ± mesajÄ±nÄ± al
         */
        function getLastUserMessage() {
            const messages = document.querySelectorAll('.message.user');
            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                const content = lastMessage.querySelector('.message-content div');
                return content ? content.textContent.trim() : '';
            }
            return '';
        }

        /**
         * Local command iÅŸleme - AkÄ±llÄ± Fallback sistemi
         */
        /**
         * AkÄ±llÄ± komut analizi - 8 kategori
         * 
         * Bu fonksiyon kullanÄ±cÄ± mesajlarÄ±nÄ± analiz eder ve uygun aksiyonu belirler.
         * Ã–ncelik sÄ±rasÄ±: MenÃ¼ > Sepet GÃ¶ster > Sepetten Ã‡Ä±kar > Sepete Ekle > SipariÅŸ > Durum > Ä°ptal > Fallback
         * 
         * Args:
         *     message (str): KullanÄ±cÄ±nÄ±n gÃ¶nderdiÄŸi mesaj
         *     
         * Returns:
         *     Promise<void>: Asenkron iÅŸlem sonucu
         *     
         * Examples:
         *     handleLocalCommand("menÃ¼ gÃ¶ster")     # MenÃ¼ listele
         *     handleLocalCommand("sepeti gÃ¶ster")  # Sepet gÃ¶ster
         *     handleLocalCommand("pizza ekle")     # Pizza sepete ekle
         *     handleLocalCommand("sipariÅŸ ver")     # SipariÅŸ oluÅŸtur
         */
        // Function call handling artÄ±k backend'de yapÄ±lÄ±yor
        // Frontend sadece mesajlarÄ± gÃ¶steriyor

        /**
         * AkÄ±llÄ± cevap Ã¼retme - restoran bilgileri ile
         */
        async function generateSmartResponse(message) {
            try {
                console.log('ğŸ§  AkÄ±llÄ± cevap Ã¼retiliyor:', message);
                
                // Restoran bilgilerini al
                const restaurantResponse = await fetch(`${API_BASE}/restaurants/${currentRestaurantId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const restaurant = await restaurantResponse.json();
                
                // MenÃ¼ bilgilerini al
                const [itemsResponse, menusResponse] = await Promise.all([
                    fetch(`${API_BASE}/menu/${currentRestaurantId}/items`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch(`${API_BASE}/menu/${currentRestaurantId}/menus`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);
                const items = await itemsResponse.json();
                const menus = await menusResponse.json();
                
                // Soru tÃ¼rÃ¼ne gÃ¶re cevap Ã¼ret
                if (message.includes('sen kimsin') || message.includes('kimsin') || message.includes('adÄ±n ne')) {
                    return `Merhaba! Ben ${restaurant.name} restoranÄ±nÄ±n dijital asistanÄ±yÄ±m. Size sipariÅŸ verme konusunda yardÄ±mcÄ± olabilirim. MenÃ¼mÃ¼zde ${items.length} farklÄ± Ã¼rÃ¼n ve ${menus.length} combo menÃ¼ bulunuyor. Size nasÄ±l yardÄ±mcÄ± olabilirim?`;
                }
                
                if (message.includes('neler yapabilirsin') || message.includes('ne yapabilirsin')) {
                    return `Size ÅŸunlarÄ± yapabilirim:\n\nğŸ½ï¸ MenÃ¼mÃ¼zÃ¼ gÃ¶sterebilirim\nğŸ›’ ÃœrÃ¼nleri sepete ekleyebilirim\nğŸ“¦ SipariÅŸinizi oluÅŸturabilirim\nğŸ“Š SipariÅŸ durumunuzu sorgulayabilirim\nâŒ SipariÅŸinizi iptal edebilirim\n\n${restaurant.name} restoranÄ±nda ${items.length + menus.length} farklÄ± lezzet sizi bekliyor!`;
                }
                
                if (message.includes('hangi restoran') || message.includes('Ã§alÄ±ÅŸÄ±yorsun')) {
                    return `${restaurant.name} restoranÄ±nda Ã§alÄ±ÅŸÄ±yorum! ${restaurant.description || 'Lezzetli yemeklerimiz ve kaliteli hizmetimizle sizlere hizmet veriyoruz.'} MenÃ¼mÃ¼zde pizza, hamburger, iÃ§ecekler ve tatlÄ±lar bulunuyor.`;
                }
                
                if (message.includes('nasÄ±lsÄ±n') || message.includes('ne haber') || message.includes('naber')) {
                    const responses = [
                        `Ã‡ok iyiyim, teÅŸekkÃ¼rler! ${restaurant.name} restoranÄ±nda size hizmet vermekten mutluyum. BugÃ¼n hangi lezzetleri denemek istiyorsunuz?`,
                        `Harika! Size yardÄ±mcÄ± olmak iÃ§in buradayÄ±m. MenÃ¼mÃ¼zde pizza, hamburger ve daha birÃ§ok lezzet var.`,
                        `Ã‡ok iyiyim! ${restaurant.name} restoranÄ±nÄ±n asistanÄ± olarak sizlere en iyi hizmeti vermeye Ã§alÄ±ÅŸÄ±yorum.`
                    ];
                    return responses[Math.floor(Math.random() * responses.length)];
                }
                
                if (message.includes('merhaba') || message.includes('selam')) {
                    const responses = [
                        `Merhaba! ${restaurant.name} restoranÄ±na hoÅŸ geldiniz! Size nasÄ±l yardÄ±mcÄ± olabilirim?`,
                        `Selam! BugÃ¼n hangi lezzetleri denemek istiyorsunuz? MenÃ¼mÃ¼zde ${items.length + menus.length} farklÄ± seÃ§enek var!`,
                        `Merhaba! Ben ${restaurant.name} restoranÄ±nÄ±n dijital asistanÄ±yÄ±m. SipariÅŸ vermek ister misiniz?`
                    ];
                    return responses[Math.floor(Math.random() * responses.length)];
                }
                
                if (message.includes('restoran') || message.includes('bilgi') || message.includes('hakkÄ±nda')) {
                    return `${restaurant.name} restoranÄ± hakkÄ±nda:\n\n${restaurant.description || 'Lezzetli yemeklerimiz ve kaliteli hizmetimizle sizlere hizmet veriyoruz.'}\n\nMenÃ¼mÃ¼zde:\nâ€¢ ${items.length} farklÄ± Ã¼rÃ¼n\nâ€¢ ${menus.length} combo menÃ¼\nâ€¢ Pizza, hamburger, iÃ§ecekler ve tatlÄ±lar\n\nSize nasÄ±l yardÄ±mcÄ± olabilirim?`;
                }
                
                // VarsayÄ±lan cevap
                return `Merhaba! Ben ${restaurant.name} restoranÄ±nÄ±n dijital asistanÄ±yÄ±m. Size sipariÅŸ verme konusunda yardÄ±mcÄ± olabilirim. MenÃ¼ gÃ¶rmek iÃ§in "menÃ¼" diyebilirsiniz!`;
                
            } catch (error) {
                console.error('âŒ AkÄ±llÄ± cevap hatasÄ±:', error);
                return 'Merhaba! Ben restoran asistanÄ±nÄ±zÄ±m. Size nasÄ±l yardÄ±mcÄ± olabilirim?';
            }
        }

        /**
         * Mesajdan adet Ã§Ä±karma
         * 
         * Bu fonksiyon kullanÄ±cÄ± mesajÄ±ndan adet bilgisini Ã§Ä±karÄ±r.
         * Hem rakam hem de TÃ¼rkÃ§e sayÄ± kelimelerini destekler.
         * 
         * Args:
         *     message (str): KullanÄ±cÄ± mesajÄ±
         *     
         * Returns:
         *     number: Ã‡Ä±karÄ±lan adet (varsayÄ±lan: 1)
         *     
         * Examples:
         *     extractQuantity("2 tane hamburger")  # 2
         *     extractQuantity("bir pizza")        # 1
         *     extractQuantity("Ã¼Ã§ kola")          # 3
         *     extractQuantity("5 adet")           # 5
         */
        function extractQuantity(message) {
            const lowerMessage = message.toLowerCase();
            
            // SayÄ±larÄ± ara
            const numbers = lowerMessage.match(/\d+/g);
            if (numbers) {
                return parseInt(numbers[0]);
            }
            
            // TÃ¼rkÃ§e sayÄ±lar
            const turkishNumbers = {
                'bir': 1, 'iki': 2, 'Ã¼Ã§': 3, 'dÃ¶rt': 4, 'beÅŸ': 5,
                'altÄ±': 6, 'yedi': 7, 'sekiz': 8, 'dokuz': 9, 'on': 10
            };
            
            for (const [word, num] of Object.entries(turkishNumbers)) {
                if (lowerMessage.includes(word)) {
                    return num;
                }
            }
            
            return 1; // VarsayÄ±lan
        }

        /**
         * GeliÅŸmiÅŸ fuzzy matching ile en iyi eÅŸleÅŸmeyi bul
         * 
         * Bu fonksiyon kullanÄ±cÄ±nÄ±n arama terimini menÃ¼deki Ã¼rÃ¼nlerle
         * Ã§ok geliÅŸmiÅŸ fuzzy matching algoritmasÄ± ile eÅŸleÅŸtirir.
         * Binlerce farklÄ± Ã¼rÃ¼n iÃ§in genel ve esnek bir sistem.
         * 
         * Args:
         *     searchTerm (str): Aranacak Ã¼rÃ¼n adÄ±
         *     items (Array): MenÃ¼deki Ã¼rÃ¼n listesi
         *     
         * Returns:
         *     Object|null: En iyi eÅŸleÅŸen Ã¼rÃ¼n veya null
         *     
         * Examples:
         *     findBestMatch("pizza", menuItems)        # TÃ¼m pizza tÃ¼rlerini bul
         *     findBestMatch("kola", menuItems)        # Cola iÃ§eren iÃ§ecekleri bul
         *     findBestMatch("iÃ§ecek", menuItems)      # TÃ¼m iÃ§ecekleri bul
         *     findBestMatch("peynirli", menuItems)    # Peynir iÃ§eren yemekleri bul
         */
        function findBestMatch(searchTerm, items) {
            if (!items || items.length === 0) return null;
            
            const lowerSearch = searchTerm.toLowerCase().trim();
            let bestMatch = null;
            let bestScore = 0;
            
            // GeliÅŸmiÅŸ kategori ve genel terimler sistemi
            const categoryMap = {
                // Ä°Ã§ecek kategorileri
                'iÃ§ecek': ['cola', 'fanta', 'sprite', 'ayran', 'Ã§ay', 'kahve', 'su', 'meyve', 'soda', 'ice', 'drink', 'beverage', 'iÃ§ecek', 'sÄ±vÄ±'],
                'kola': ['cola', 'coca', 'pepsi', 'zero', 'light', 'diet'],
                'Ã§ay': ['Ã§ay', 'tea', 'demleme', 'siyah', 'yeÅŸil', 'bitki'],
                'kahve': ['kahve', 'coffee', 'americano', 'latte', 'cappuccino', 'espresso', 'mocha'],
                'su': ['su', 'water', 'mineral', 'doÄŸal', 'soda'],
                
                // Yemek kategorileri
                'yemek': ['pizza', 'hamburger', 'sandwich', 'salata', 'makarna', 'kÃ¶fte', 'tavuk', 'et', 'balÄ±k', 'yemek', 'food', 'meal'],
                'pizza': ['pizza', 'pide', 'lahmacun', 'margherita', 'pepperoni', 'quattro', 'stagioni'],
                'burger': ['hamburger', 'burger', 'sandwich', 'wrap', 'tortilla', 'ekmek'],
                'salata': ['salata', 'yeÅŸillik', 'marul', 'domates', 'salad', 'green', 'fresh'],
                'makarna': ['makarna', 'pasta', 'spaghetti', 'penne', 'fettuccine', 'ravioli', 'lasagna'],
                'kÃ¶fte': ['kÃ¶fte', 'meatball', 'kÃ¶fte', 'kÃ¶fte', 'kÃ¶fte'],
                
                // Protein kategorileri
                'tavuk': ['tavuk', 'chicken', 'piliÃ§', 'kanat', 'wings', 'breast', 'thigh'],
                'et': ['et', 'kÃ¶fte', 'kuzu', 'dana', 'sÄ±ÄŸÄ±r', 'beef', 'lamb', 'meat'],
                'balÄ±k': ['balÄ±k', 'fish', 'somon', 'levrek', 'tuna', 'salmon', 'seabass'],
                'deniz': ['deniz', 'sea', 'ocean', 'marine', 'su', 'water'],
                
                // Diyet kategorileri
                'vegan': ['vegan', 'vejetaryen', 'bitkisel', 'plant', 'vegetable'],
                'vejetaryen': ['vejetaryen', 'vegetarian', 'veggie', 'bitkisel'],
                'gluten': ['gluten', 'gluten-free', 'gluten', 'buÄŸday'],
                'laktoz': ['laktoz', 'lactose', 'sÃ¼t', 'milk', 'dairy'],
                
                // Tat kategorileri
                'acÄ±': ['acÄ±', 'biber', 'hot', 'spicy', 'chili', 'pepper'],
                'tatlÄ±': ['tatlÄ±', 'sweet', 'ÅŸekerli', 'sugar', 'honey', 'syrup'],
                'tuzlu': ['tuzlu', 'salty', 'tuz', 'salt'],
                'ekÅŸi': ['ekÅŸi', 'sour', 'limon', 'lemon', 'vinegar'],
                
                // PiÅŸirme yÃ¶ntemleri
                'kÄ±zartma': ['kÄ±zartma', 'fried', 'kÄ±zarmÄ±ÅŸ', 'crispy', 'golden'],
                'fÄ±rÄ±n': ['fÄ±rÄ±n', 'baked', 'oven', 'roasted'],
                'haÅŸlama': ['haÅŸlama', 'boiled', 'steamed', 'cooked'],
                'Ä±zgara': ['Ä±zgara', 'grilled', 'barbecue', 'bbq'],
                
                // Boyut kategorileri
                'bÃ¼yÃ¼k': ['bÃ¼yÃ¼k', 'large', 'big', 'xl', 'extra'],
                'orta': ['orta', 'medium', 'mid', 'm'],
                'kÃ¼Ã§Ã¼k': ['kÃ¼Ã§Ã¼k', 'small', 'mini', 's'],
                
                // Malzeme kategorileri
                'peynir': ['peynir', 'cheese', 'mozzarella', 'cheddar', 'parmesan'],
                'et': ['et', 'meat', 'beef', 'chicken', 'pork', 'lamb'],
                'sebze': ['sebze', 'vegetable', 'veggie', 'green', 'fresh'],
                'baharat': ['baharat', 'spice', 'herb', 'seasoning', 'flavor'],
                
                // Ã–zel istekler
                'acÄ±sÄ±z': ['acÄ±sÄ±z', 'mild', 'no-spice', 'gentle'],
                'ekstra': ['ekstra', 'extra', 'more', 'additional'],
                'az': ['az', 'less', 'light', 'minimal'],
                'sos': ['sos', 'sauce', 'dressing', 'dip']
            };
            
            for (const item of items) {
                const itemName = item.name.toLowerCase();
                let score = 0;
                
                // 1. Tam eÅŸleÅŸme (en yÃ¼ksek skor)
                if (itemName === lowerSearch) {
                    return { ...item, score: 100 };
                }
                
                // 2. Kategori eÅŸleÅŸmesi (Ã§ok geliÅŸmiÅŸ)
                for (const [category, keywords] of Object.entries(categoryMap)) {
                    // Ana kategori kontrolÃ¼
                    if (lowerSearch.includes(category)) {
                        for (const keyword of keywords) {
                            if (itemName.includes(keyword)) {
                                score += 40; // YÃ¼ksek skor
                        break;
                            }
                        }
                    }
                    
                    // Ters eÅŸleÅŸme (Ã¼rÃ¼n adÄ±nda kategori varsa)
                    for (const keyword of keywords) {
                        if (lowerSearch.includes(keyword)) {
                            if (itemName.includes(category) || itemName.includes(keyword)) {
                                score += 35;
                        break;
                            }
                        }
                    }
                }
                
                // 2.5. Ã‡oklu kelime eÅŸleÅŸmesi
                const searchWords = lowerSearch.split(/\s+/);
                let multiWordScore = 0;
                for (const searchWord of searchWords) {
                    for (const [category, keywords] of Object.entries(categoryMap)) {
                        if (searchWord.includes(category)) {
                            for (const keyword of keywords) {
                                if (itemName.includes(keyword)) {
                                    multiWordScore += 25;
                        break;
                                }
                            }
                        }
                    }
                }
                score += multiWordScore;
                
                // 3. GeliÅŸmiÅŸ kelime bazlÄ± eÅŸleÅŸme
                const itemWords = itemName.split(/\s+/);
                
                for (const searchWord of searchWords) {
                    for (const itemWord of itemWords) {
                        // Tam kelime eÅŸleÅŸmesi
                        if (itemWord === searchWord) {
                            score += 25;
                        }
                        // Kelime iÃ§erme
                        else if (itemWord.includes(searchWord) || searchWord.includes(itemWord)) {
                            score += 15;
                        }
                        // Levenshtein benzeri eÅŸleÅŸme
                        else if (calculateSimilarity(itemWord, searchWord) > 0.6) {
                            score += 12;
                        }
                        // KÄ±saltma eÅŸleÅŸmesi
                        else if (isAbbreviation(searchWord, itemWord) || isAbbreviation(itemWord, searchWord)) {
                            score += 18;
                        }
                        // TÃ¼rkÃ§e karakter eÅŸleÅŸmesi
                        else if (normalizeTurkish(searchWord) === normalizeTurkish(itemWord)) {
                            score += 20;
                        }
                    }
                }
                
                // 4. Genel iÃ§erme kontrolÃ¼
                if (itemName.includes(lowerSearch) || lowerSearch.includes(itemName)) {
                    score += 15;
                }
                
                // 5. BaÅŸlangÄ±Ã§ eÅŸleÅŸmesi (bonus)
                if (itemName.startsWith(lowerSearch) || lowerSearch.startsWith(itemName)) {
                    score += 25;
                }
                
                // En iyi skoru gÃ¼ncelle
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = item;
                }
            }
            
            // Minimum skor kontrolÃ¼ (Ã§ok dÃ¼ÅŸÃ¼k skorlarÄ± reddet)
            // Daha esnek minimum skor - binlerce Ã¼rÃ¼n iÃ§in
            console.log(`ğŸ” Arama: "${searchTerm}" â†’ En yÃ¼ksek skor: ${bestScore}, En iyi eÅŸleÅŸme: ${bestMatch?.name}`);
            
            if (bestMatch && bestScore > 1) { // Minimum skoru 3'ten 1'e dÃ¼ÅŸÃ¼rdÃ¼k
                console.log(`ğŸ¯ EÅŸleÅŸme bulundu: "${searchTerm}" â†’ "${bestMatch.name}" (Skor: ${bestScore})`);
                return { ...bestMatch, score: bestScore };
            } else {
                console.log(`âŒ EÅŸleÅŸme bulunamadÄ±: "${searchTerm}" (En yÃ¼ksek skor: ${bestScore})`);
                // Son Ã§are: En yÃ¼ksek skorlu Ã¼rÃ¼nÃ¼ dÃ¶ndÃ¼r (Ã§ok dÃ¼ÅŸÃ¼k skor olsa bile)
                if (bestMatch && bestScore > 0) {
                    console.log(`âš ï¸ Son Ã§are eÅŸleÅŸme: "${searchTerm}" â†’ "${bestMatch.name}" (Skor: ${bestScore})`);
                    return { ...bestMatch, score: bestScore };
                }
                return null;
            }
        }
        
        /**
         * Ä°ki string arasÄ±ndaki benzerliÄŸi hesapla (Levenshtein benzeri)
         */
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }
        
        /**
         * Levenshtein mesafesi hesapla
         */
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        /**
         * KÄ±saltma kontrolÃ¼
         */
        function isAbbreviation(short, long) {
            if (short.length >= long.length) return false;
            
            let shortIndex = 0;
            for (let i = 0; i < long.length && shortIndex < short.length; i++) {
                if (long[i].toLowerCase() === short[shortIndex].toLowerCase()) {
                    shortIndex++;
                }
            }
            return shortIndex === short.length;
        }
        
        /**
         * TÃ¼rkÃ§e karakterleri normalize et
         */
        function normalizeTurkish(str) {
            return str
                .toLowerCase()
                .replace(/ÄŸ/g, 'g')
                .replace(/Ã¼/g, 'u')
                .replace(/ÅŸ/g, 's')
                .replace(/Ä±/g, 'i')
                .replace(/Ã¶/g, 'o')
                .replace(/Ã§/g, 'c');
        }

        /**
         * AkÄ±llÄ± sepetten Ã§Ä±karma - Fuzzy matching ile
         * 
         * Bu fonksiyon kullanÄ±cÄ±nÄ±n belirttiÄŸi Ã¼rÃ¼n adÄ±nÄ± fuzzy matching
         * algoritmasÄ± ile menÃ¼deki gerÃ§ek Ã¼rÃ¼nlerle eÅŸleÅŸtirir ve sepetten Ã§Ä±karÄ±r.
         * 
         * Args:
         *     itemName (str): Ã‡Ä±karÄ±lacak Ã¼rÃ¼n adÄ±
         *     originalMessage (str): Orijinal kullanÄ±cÄ± mesajÄ± (adet Ã§Ä±karma iÃ§in)
         *     
         * Returns:
         *     Promise<Object>: Ä°ÅŸlem sonucu {success: bool, message: str}
         *     
         * Examples:
         *     removeFromCart("hamburger", "1 tane hamburger Ã§Ä±kar")  # 1 adet hamburger Ã§Ä±kar
         *     removeFromCart("pizza", "pizza sepetten Ã§Ä±kar")        # 1 adet pizza Ã§Ä±kar
         *     removeFromCart("kola", "3 tane kola Ã§Ä±kar")           # 3 adet kola Ã§Ä±kar
         */
        async function removeFromCart(itemName, originalMessage) {
            console.log('ğŸ—‘ï¸ AkÄ±llÄ± sepetten Ã§Ä±karma:', itemName, 'Original:', originalMessage);
            
            try {
                // Adet kontrolÃ¼
                const quantity = extractQuantity(originalMessage) || 1;
                console.log('ğŸ”¢ Ã‡Ä±karÄ±lacak adet:', quantity);
                
                // MenÃ¼ verilerini al
                const [itemsResponse, menusResponse] = await Promise.all([
                    fetch(`${API_BASE}/menu/${currentRestaurantId}/items`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch(`${API_BASE}/menu/${currentRestaurantId}/menus`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);
                
                const items = await itemsResponse.json();
                const menus = await menusResponse.json();
                const allItems = [...items, ...menus];
                
                // Fuzzy matching ile en iyi eÅŸleÅŸmeyi bul
                const bestMatch = findBestMatch(itemName, allItems);
                console.log('ğŸ¯ Ã‡Ä±karÄ±lacak Ã¼rÃ¼n:', bestMatch?.name, 'Skor:', bestMatch?.score);
                
                if (bestMatch && bestMatch.score > 0.3) {
                    // Sepetten Ã§Ä±kar - isim ile bul
                    const result = await removeFromCartByName(bestMatch.name, quantity);
                    return {
                        message: `ğŸ—‘ï¸ "${itemName}" sepetten Ã§Ä±karÄ±ldÄ± â†’ ${result.message}`,
                        success: true
                    };
                } else {
                    // ÃœrÃ¼n bulunamadÄ±
                    const availableItems = allItems.map(item => item.name).join(', ');
                    return {
                        message: `âŒ "${itemName}" bulunamadÄ±. Mevcut Ã¼rÃ¼nler: ${availableItems}`,
                        success: false
                    };
                }
            } catch (error) {
                console.error('AkÄ±llÄ± sepetten Ã§Ä±karma hatasÄ±:', error);
                return {
                    message: 'âŒ Sepetten Ã§Ä±karma sÄ±rasÄ±nda hata oluÅŸtu.',
                    success: false
                };
            }
        }

        /**
         * AkÄ±llÄ± sepete ekleme - Fuzzy matching ile
         * 
         * Bu fonksiyon kullanÄ±cÄ±nÄ±n belirttiÄŸi Ã¼rÃ¼n adÄ±nÄ± fuzzy matching
         * algoritmasÄ± ile menÃ¼deki gerÃ§ek Ã¼rÃ¼nlerle eÅŸleÅŸtirir ve sepete ekler.
         * 
         * Args:
         *     itemName (str): KullanÄ±cÄ±nÄ±n belirttiÄŸi Ã¼rÃ¼n adÄ±
         *     originalMessage (str): Orijinal kullanÄ±cÄ± mesajÄ± (adet Ã§Ä±karma iÃ§in)
         *     
         * Returns:
         *     Promise<Object>: Ä°ÅŸlem sonucu {success: bool, message: str}
         *     
         * Examples:
         *     smartAddToCart("hamburger", "2 tane hamburger ekle")  # 2 adet hamburger ekle
         *     smartAddToCart("pizza", "pizza sepete ekle")          # 1 adet pizza ekle
         *     smartAddToCart("kola", "3 tane kola ekle")           # 3 adet kola ekle
         */
        async function smartAddToCart(itemName, originalMessage) {
            console.log('ğŸ§  AkÄ±llÄ± sepete ekleme:', itemName, 'Original:', originalMessage);
            
            try {
                // Ã‡oklu Ã¼rÃ¼n kontrolÃ¼ - "ve" kelimesi veya sayÄ± + Ã¼rÃ¼n pattern'i varsa
                if (originalMessage.toLowerCase().includes(' ve ') || 
                    /\d+\s+adet\s+[^0-9]+?\s+\d+\s+adet/.test(originalMessage)) {
                    console.log('ğŸ”„ Ã‡oklu Ã¼rÃ¼n tespit edildi');
                    return await handleMultipleItems(originalMessage);
                }
                
                // Adet bilgisini Ã§Ä±kar
                const quantity = extractQuantity(originalMessage);
                console.log('ğŸ“Š Ã‡Ä±karÄ±lan adet:', quantity);
                
                // Ã–nce normal eklemeyi dene (adet ile)
                const normalResult = await addToCart(itemName, quantity);
                if (normalResult.success) {
                    return normalResult;
                }
                
                // Bulunamazsa, mesajdan akÄ±llÄ± Ã§Ä±karÄ±m yap
                const lowerOriginal = originalMessage.toLowerCase();
                
                // MenÃ¼ verilerini al
                const [itemsResponse, menusResponse] = await Promise.all([
                    fetch(`${API_BASE}/menu/${currentRestaurantId}/items`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch(`${API_BASE}/menu/${currentRestaurantId}/menus`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);
                
                const items = await itemsResponse.json();
                const menus = await menusResponse.json();
                const allItems = [...items, ...menus];
                
                console.log('ğŸ“‹ Mevcut Ã¼rÃ¼nler:', allItems.map(i => i.name));
                
                // GeliÅŸmiÅŸ fuzzy matching - tam eÅŸleÅŸme Ã¶ncelikli
                let bestMatch = null;
                let maxScore = 0;
                
                allItems.forEach(item => {
                    const itemName = item.name.toLowerCase();
                    let score = 0;
                    
                    // 1. Tam eÅŸleÅŸme (en yÃ¼ksek skor)
                    if (itemName === lowerOriginal) {
                        score = 10000;
                    }
                    // 2. Tam iÃ§erme kontrolÃ¼ (Ã§ok yÃ¼ksek skor)
                    else if (itemName.includes(lowerOriginal)) {
                        score = 8000;
                    }
                    // 3. BaÅŸlangÄ±Ã§ eÅŸleÅŸmesi (yÃ¼ksek skor)
                    else if (itemName.startsWith(lowerOriginal) || lowerOriginal.startsWith(itemName)) {
                        score = 6000;
                    }
                    // 4. Ã‡oklu kelime eÅŸleÅŸmesi - genel sistem
                    else {
                        const searchWords = lowerOriginal.split(/\s+/);
                        const itemWords = itemName.split(/\s+/);
                        let multiWordScore = 0;
                        
                        // Her arama kelimesi iÃ§in eÅŸleÅŸme kontrolÃ¼
                        for (const searchWord of searchWords) {
                            for (const itemWord of itemWords) {
                                if (itemWord.includes(searchWord) || searchWord.includes(itemWord)) {
                                    multiWordScore += 1000; // YÃ¼ksek skor
                                }
                            }
                        }
                        
                        if (multiWordScore > 0) {
                            score = multiWordScore;
                        }
                    }
                    
                    if (score > maxScore) {
                        maxScore = score;
                        bestMatch = item;
                    }
                });
                
                console.log('ğŸ¯ En iyi eÅŸleÅŸme:', bestMatch?.name, 'Skor:', maxScore);
                
                if (bestMatch && maxScore > 50) { // Minimum skor 50 - daha seÃ§ici
                    // EÅŸleÅŸen Ã¼rÃ¼nÃ¼ sepete ekle (adet ile)
                    const result = await addToCart(bestMatch.name, quantity);
                    return {
                        success: true,
                        message: `ğŸ§  "${itemName}" olarak anladÄ±m â†’ ${result.message}`
                    };
                } else {
                    return {
                        success: false,
                        message: `âŒ "${itemName}" bulunamadÄ±. Mevcut Ã¼rÃ¼nler: ${allItems.map(i => i.name).join(', ')}`
                    };
                }
                
            } catch (error) {
                console.error('âŒ AkÄ±llÄ± ekleme hatasÄ±:', error);
                return { success: false, message: 'ÃœrÃ¼n eklenirken hata oluÅŸtu.' };
            }
        }

        /**
         * SipariÅŸ iptal etme - Durum kontrolÃ¼ ile
         */
        async function cancelOrder(orderId) {
            try {
                console.log('ğŸ—‘ï¸ SipariÅŸ iptal ediliyor:', orderId);
                
                // Ã–nce sipariÅŸ durumunu kontrol et
                const statusResponse = await fetch(`${API_BASE}/orders/${orderId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!statusResponse.ok) {
                    if (statusResponse.status === 404) {
                        return {
                            success: false,
                            message: `âŒ SipariÅŸ #${orderId} bulunamadÄ±`
                        };
                    } else if (statusResponse.status === 403) {
                        return {
                            success: false,
                            message: `âŒ Bu sipariÅŸe eriÅŸim yetkiniz yok (SipariÅŸ #${orderId})`
                        };
                    } else {
                        return {
                            success: false,
                            message: 'âŒ SipariÅŸ bilgileri alÄ±namadÄ±'
                        };
                    }
                }
                
                const order = await statusResponse.json();
                const status = order.status.toLowerCase();
                
                // Durum kontrolÃ¼
                if (status === 'delivered') {
                    return {
                        success: false,
                        message: `âŒ SipariÅŸ #${orderId} zaten teslim edilmiÅŸ. Teslim edilen sipariÅŸler iptal edilemez.`
                    };
                } else if (status === 'delivering') {
                    return {
                        success: false,
                        message: `âŒ SipariÅŸ #${orderId} yolda! Teslimat baÅŸladÄ±ÄŸÄ± iÃ§in iptal edilemez.`
                    };
                } else if (status === 'cancelled') {
                    return {
                        success: false,
                        message: `âŒ SipariÅŸ #${orderId} zaten iptal edilmiÅŸ.`
                    };
                } else if (status === 'preparing') {
                    return {
                        success: false,
                        message: `âŒ SipariÅŸ #${orderId} hazÄ±rlanÄ±yor! Mutfakta iÅŸlem gÃ¶ren sipariÅŸler iptal edilemez.`
                    };
                }
                
                // Ä°ptal iÅŸlemi
                const response = await fetch(`${API_BASE}/orders/${orderId}/cancel`, {
                    method: 'PUT',
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
                
                if (response.ok) {
                    const result = await response.json();
                    return {
                        success: true,
                        message: `âœ… SipariÅŸ #${orderId} baÅŸarÄ±yla iptal edildi. ${result.refund_amount || ''}â‚º cÃ¼zdanÄ±nÄ±za iade edildi.`
                    };
                } else {
                    const error = await response.json();
                    return {
                        success: false,
                        message: error.detail || 'âŒ SipariÅŸ iptal edilemedi'
                    };
                }
            } catch (error) {
                console.error('âŒ SipariÅŸ iptal hatasÄ±:', error);
                return {
                    success: false,
                    message: 'âŒ SipariÅŸ iptal edilirken hata oluÅŸtu'
                };
            }
        }

        /**
         * ÃœrÃ¼n adÄ±nÄ± mesajdan Ã§Ä±kar - GeliÅŸtirilmiÅŸ
         * 
         * Bu fonksiyon kullanÄ±cÄ± mesajÄ±ndan Ã¼rÃ¼n adÄ±nÄ± Ã§Ä±karÄ±r.
         * Sepete ekleme komutlarÄ±nÄ± ve sayÄ±larÄ± temizleyerek sadece Ã¼rÃ¼n adÄ±nÄ± dÃ¶ner.
         * 
         * Args:
         *     message (str): KullanÄ±cÄ± mesajÄ±
         *     
         * Returns:
         *     str: TemizlenmiÅŸ Ã¼rÃ¼n adÄ±
         *     
         * Examples:
         *     extractItemName("2 tane hamburger sepete ekle")  # "hamburger"
         *     extractItemName("pizza ekle")                    # "pizza"
         *     extractItemName("bir kola sepeti")              # "kola"
         */
        function extractItemName(message) {
            const words = message.split(' ');
            const keywords = ['sepete', 'sepeti', 'ekle', 'ekleyin', 'ek', 'sepe', 'spete'];
            
            // Anahtar kelimelerden Ã¶nceki kelimeleri al
            for (let i = 0; i < words.length; i++) {
                if (keywords.some(keyword => words[i].toLowerCase().includes(keyword))) {
                    const itemWords = words.slice(0, i);
                    if (itemWords.length > 0) {
                        return itemWords.join(' ').trim();
                    }
                }
            }
            
            // Anahtar kelime bulunamazsa, temizle
            let cleanedMessage = message
                .replace(/sepete|sepeti|ekle|ekleyin|ek|sepe|spete/gi, '')
                .replace(/olacak/gi, '') // "2 tane olacak 2 tane" iÃ§in
                .replace(/tane|adet|bir|iki|Ã¼Ã§|dÃ¶rt|beÅŸ|altÄ±|yedi|sekiz|dokuz|on/gi, '') // SayÄ±larÄ± temizle
                .replace(/\d+/g, '') // RakamlarÄ± temizle
                .replace(/\s+/g, ' ')
                .trim();
            
            // BoÅŸsa, orjinal mesajdan ilk kelimeleri al
            if (!cleanedMessage) {
                cleanedMessage = words.slice(0, 2).join(' ').trim();
            }
            
            return cleanedMessage;
        }

        /**
         * MenÃ¼ Ã¶ÄŸelerini getir - Kategorilere gÃ¶re dÃ¼zenlenmiÅŸ
         */
        async function getMenuItems() {
            try {
                const [itemsResponse, menusResponse] = await Promise.all([
                    fetch(`${API_BASE}/menu/${currentRestaurantId}/items`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch(`${API_BASE}/menu/${currentRestaurantId}/menus`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);
                
                const items = await itemsResponse.json();
                const menus = await menusResponse.json();
                
                let menuText = `${selectedRestaurant?.name || 'Restoran'} MenÃ¼sÃ¼:\n\n`;
                
                // Kategorilere gÃ¶re Ã¼rÃ¼nleri ayÄ±r
                const categories = {
                    'yemekler': [],
                    'iÃ§ecekler': [],
                    'tatlÄ±lar': [],
                    'diÄŸer': []
                };
                
                // Tek Ã¼rÃ¼nleri kategorilere ayÄ±r - Database type'Ä±na gÃ¶re
                items.forEach(item => {
                    const itemType = item.type ? item.type.toLowerCase() : 'diÄŸer';
                    
                    if (itemType.includes('iÃ§ecek') || itemType.includes('drink') || itemType.includes('beverage')) {
                        categories.iÃ§ecekler.push(item);
                    } 
                    else if (itemType.includes('tatlÄ±') || itemType.includes('dessert') || itemType.includes('sweet')) {
                        categories.tatlÄ±lar.push(item);
                    } 
                    else if (itemType.includes('yemek') || itemType.includes('food') || itemType.includes('meal')) {
                        categories.yemekler.push(item);
                    } 
                    else {
                        categories.diÄŸer.push(item);
                    }
                });
                
                // Combo menÃ¼leri kategorilere ayÄ±r - TÃ¼mÃ¼ combo
                menus.forEach(menu => {
                    const menuType = menu.type ? menu.type.toLowerCase() : 'diÄŸer';
                    
                    if (menuType.includes('iÃ§ecek') || menuType.includes('drink') || menuType.includes('beverage')) {
                        categories.iÃ§ecekler.push({...menu, isCombo: true});
                    } 
                    else if (menuType.includes('tatlÄ±') || menuType.includes('dessert') || menuType.includes('sweet')) {
                        categories.tatlÄ±lar.push({...menu, isCombo: true});
                    } 
                    else if (menuType.includes('yemek') || menuType.includes('food') || menuType.includes('meal')) {
                        categories.yemekler.push({...menu, isCombo: true});
                    } 
                    else {
                        categories.diÄŸer.push({...menu, isCombo: true});
                    }
                });
                
                // Kategorileri gÃ¶ster
                if (categories.yemekler.length > 0) {
                    menuText += "ğŸ½ï¸ YEMEKLER:\n";
                    categories.yemekler.forEach(item => {
                        const comboIcon = item.isCombo ? "ğŸ± " : "â€¢ ";
                        menuText += `${comboIcon}${item.name}: ${item.price} TL\n`;
                    });
                    menuText += "\n";
                }
                
                if (categories.iÃ§ecekler.length > 0) {
                    menuText += "ğŸ¥¤ Ä°Ã‡ECEKLER:\n";
                    categories.iÃ§ecekler.forEach(item => {
                        const comboIcon = item.isCombo ? "ğŸ± " : "â€¢ ";
                        menuText += `${comboIcon}${item.name}: ${item.price} TL\n`;
                    });
                    menuText += "\n";
                }
                
                if (categories.tatlÄ±lar.length > 0) {
                    menuText += "ğŸ° TATLILAR:\n";
                    categories.tatlÄ±lar.forEach(item => {
                        const comboIcon = item.isCombo ? "ğŸ± " : "â€¢ ";
                        menuText += `${comboIcon}${item.name}: ${item.price} TL\n`;
                    });
                    menuText += "\n";
                }
                
                if (categories.diÄŸer.length > 0) {
                    menuText += "ğŸ½ï¸ DÄ°ÄER:\n";
                    categories.diÄŸer.forEach(item => {
                        const comboIcon = item.isCombo ? "ğŸ± " : "â€¢ ";
                        menuText += `${comboIcon}${item.name}: ${item.price} TL\n`;
                    });
                }
                
                return { success: true, message: menuText };
            } catch (error) {
                console.error('âŒ MenÃ¼ hatasÄ±:', error);
                return { success: false, message: 'MenÃ¼ yÃ¼klenirken hata oluÅŸtu.' };
            }
        }

        /**
         * Ã‡oklu Ã¼rÃ¼n ekleme - "hamburger ve tatlÄ± esinti sepete ekle"
         */
        async function handleMultipleItems(message) {
            try {
                console.log('ğŸ”„ Ã‡oklu Ã¼rÃ¼n iÅŸleniyor:', message);
                
                let parts = [];
                
                // "ve" kelimesi ile bÃ¶l
                if (message.toLowerCase().includes(' ve ')) {
                    parts = message.toLowerCase().split(' ve ');
                } else {
                    // "ve" yoksa, sayÄ± + Ã¼rÃ¼n pattern'ini ara
                    // Ã–rnek: "3 adet tatlÄ± Esinti 1 adet NutellalÄ± cheesecake"
                    const numberProductPattern = /(\d+\s+adet\s+[^0-9]+?)(?=\s+\d+\s+adet|\s+ekle|$)/g;
                    const matches = message.match(numberProductPattern);
                    if (matches && matches.length > 1) {
                        parts = matches;
                    } else {
                        return { success: false, message: 'Ã‡oklu Ã¼rÃ¼n formatÄ± yanlÄ±ÅŸ.' };
                    }
                }
                
                if (parts.length < 2) {
                    return { success: false, message: 'Ã‡oklu Ã¼rÃ¼n formatÄ± yanlÄ±ÅŸ.' };
                }
                
                const results = [];
                
                // Her parÃ§ayÄ± iÅŸle
                for (let i = 0; i < parts.length; i++) {
                    let part = parts[i].trim();
                    
                    // Son parÃ§ada "sepete ekle" varsa Ã§Ä±kar
                    if (i === parts.length - 1) {
                        part = part.replace(/sepete ekle|sepeti ekle|ekle/g, '').trim();
                    }
                    
                    // Adet bilgisini Ã§Ä±kar
                    const quantity = extractQuantity(part);
                    const itemName = extractItemName(part);
                    
                    console.log(`ğŸ”„ ÃœrÃ¼n ${i + 1}:`, itemName, 'Adet:', quantity);
                    
                    // ÃœrÃ¼nÃ¼ ekle
                    const result = await addToCart(itemName, quantity);
                    if (result.success) {
                        results.push(result.message);
                    } else {
                        results.push(`âŒ ${itemName} eklenemedi`);
                    }
                }
                
                return {
                    success: true,
                    message: results.join('\n')
                };
                
            } catch (error) {
                console.error('âŒ Ã‡oklu Ã¼rÃ¼n hatasÄ±:', error);
                return { success: false, message: 'Ã‡oklu Ã¼rÃ¼n eklenirken hata oluÅŸtu.' };
            }
        }

        /**
         * Sepete Ã¼rÃ¼n ekleme
         */
        async function removeFromCartByName(itemName, quantity = 1) {
            try {
                console.log('ğŸ—‘ï¸ Sepetten Ã§Ä±karÄ±lÄ±yor:', itemName, 'Adet:', quantity);
                
                // Sepette var mÄ± kontrol et - isim ile
                const existingItemIndex = cart.findIndex(cartItem => 
                    cartItem.name.toLowerCase() === itemName.toLowerCase()
                );
                
                if (existingItemIndex === -1) {
                    return { success: false, message: 'Bu Ã¼rÃ¼n sepetinizde bulunmuyor.' };
                }
                
                const existingItem = cart[existingItemIndex];
                
                // Adet kontrolÃ¼
                if (quantity >= existingItem.quantity) {
                    // TÃ¼mÃ¼nÃ¼ Ã§Ä±kar
                    cart.splice(existingItemIndex, 1);
                    return { 
                        success: true, 
                        message: `âœ… ${existingItem.name} sepetten tamamen Ã§Ä±karÄ±ldÄ±.` 
                    };
                } else {
                    // Belirli adet Ã§Ä±kar
                    existingItem.quantity -= quantity;
                    return { 
                        success: true, 
                        message: `âœ… ${existingItem.name} sepetten ${quantity} adet Ã§Ä±karÄ±ldÄ±. (Kalan: ${existingItem.quantity})` 
                    };
                }
            } catch (error) {
                console.error('Sepetten Ã§Ä±karma hatasÄ±:', error);
                return { success: false, message: 'Sepetten Ã§Ä±karma sÄ±rasÄ±nda hata oluÅŸtu.' };
            }
        }

        async function removeFromCartAPI(itemId, quantity = 1) {
            try {
                console.log('ğŸ—‘ï¸ Sepetten Ã§Ä±karÄ±lÄ±yor:', itemId, 'Adet:', quantity);
                
                // Sepette var mÄ± kontrol et
                const existingItemIndex = cart.findIndex(cartItem => cartItem.id === itemId);
                
                if (existingItemIndex === -1) {
                    return { success: false, message: 'Bu Ã¼rÃ¼n sepetinizde bulunmuyor.' };
                }
                
                const existingItem = cart[existingItemIndex];
                
                // Adet kontrolÃ¼
                if (quantity >= existingItem.quantity) {
                    // TÃ¼mÃ¼nÃ¼ Ã§Ä±kar
                    cart.splice(existingItemIndex, 1);
                    return { 
                        success: true, 
                        message: `âœ… ${existingItem.name} sepetten tamamen Ã§Ä±karÄ±ldÄ±.` 
                    };
                } else {
                    // Belirli adet Ã§Ä±kar
                    existingItem.quantity -= quantity;
                    return { 
                        success: true, 
                        message: `âœ… ${existingItem.name} sepetten ${quantity} adet Ã§Ä±karÄ±ldÄ±. (Kalan: ${existingItem.quantity})` 
                    };
                }
            } catch (error) {
                console.error('Sepetten Ã§Ä±karma hatasÄ±:', error);
                return { success: false, message: 'Sepetten Ã§Ä±karma sÄ±rasÄ±nda hata oluÅŸtu.' };
            }
        }

        async function addToCart(itemName, quantity = 1) {
            try {
                console.log('ğŸ›’ Sepete ekleniyor:', itemName, 'Adet:', quantity);
                
                if (!itemName || itemName.trim() === '') {
                    return { success: false, message: 'Hangi Ã¼rÃ¼nÃ¼ eklemek istiyorsunuz?' };
                }
                
                // MenÃ¼ verilerini al
                const [itemsResponse, menusResponse] = await Promise.all([
                    fetch(`${API_BASE}/menu/${currentRestaurantId}/items`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch(`${API_BASE}/menu/${currentRestaurantId}/menus`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);
                
                const items = await itemsResponse.json();
                const menus = await menusResponse.json();
                
                // ÃœrÃ¼n ara
                let foundItem = null;
                let itemType = 'item'; //Ã¼rÃ¼n burada menus d eolmalÄ±
                
                // Items'da ara
                foundItem = items.find(item => 
                    item.name.toLowerCase() === itemName.toLowerCase() ||
                    item.name.toLowerCase().includes(itemName.toLowerCase()) ||
                    itemName.toLowerCase().includes(item.name.toLowerCase())
                );
                
                // Menus'da ara
                if (!foundItem) {
                    foundItem = menus.find(menu => 
                        menu.name.toLowerCase() === itemName.toLowerCase() ||
                        menu.name.toLowerCase().includes(itemName.toLowerCase()) ||
                        itemName.toLowerCase().includes(menu.name.toLowerCase())
                    );
                    if (foundItem) {
                        itemType = 'menu';
                    }
                }
                
                if (foundItem) {
                    // Sepette var mÄ± kontrol et
                    const existingItem = cart.find(cartItem => 
                        cartItem.id === foundItem.id && cartItem.type === itemType
                    );
                    
                    if (existingItem) {
                        existingItem.quantity += quantity;
                        return {
                            success: true,
                            message: `âœ… ${foundItem.name} sepete eklendi! (${existingItem.quantity} adet - ${foundItem.price * existingItem.quantity}â‚º)`
                        };
                    } else {
                        cart.push({
                            id: foundItem.id,
                            name: foundItem.name,
                            price: foundItem.price,
                            quantity: quantity,
                            type: itemType
                        });
                        return {
                            success: true,
                            message: `âœ… ${foundItem.name} sepete eklendi! (${quantity} adet - ${foundItem.price * quantity}â‚º)`
                        };
                    }
                } else {
                    return {
                        success: false,
                        message: `âŒ "${itemName}" menÃ¼de bulunamadÄ±. LÃ¼tfen menÃ¼yÃ¼ kontrol edin.`
                    };
                }
            } catch (error) {
                console.error('âŒ Sepete ekleme hatasÄ±:', error);
                return { success: false, message: 'ÃœrÃ¼n sepete eklenirken hata oluÅŸtu.' };
            }
        }

        /**
         * Sepet iÃ§eriÄŸini gÃ¶ster
         */
        async function showCart() {
            console.log('ğŸ›’ Sepet gÃ¶steriliyor, cart:', cart);
            
            if (cart.length === 0) {
                return {
                    success: true,
                    message: 'ğŸ›’ Sepetiniz boÅŸ. MenÃ¼den Ã¼rÃ¼n ekleyebilirsiniz.'
                };
            }
            
            let cartMessage = 'ğŸ›’ Sepet Ä°Ã§eriÄŸi:\n\n';
            let total = 0;
            
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                cartMessage += `${index + 1}. ${item.name} x${item.quantity} - ${itemTotal}â‚º\n`;
            });
            
            cartMessage += `\nğŸ’° Toplam: ${total}â‚º`;
            
            return { success: true, message: cartMessage };
        }

        /**
         * SipariÅŸ ID'sini mesajdan Ã§Ä±kar
         */
        function extractOrderId(message) {
            const patterns = [
                /(\d+)\s*numara/i,
                /numara\s*(\d+)/i,
                /#(\d+)/i,
                /sipariÅŸ\s*(\d+)/i,
                /(\d+)\s*sipariÅŸ/i,
                /(\d+)\s*numaralÄ±/i,
                /numaralÄ±\s*(\d+)/i
            ];
            
            for (const pattern of patterns) {
                const match = message.match(pattern);
                if (match) {
                    return parseInt(match[1]);
                }
            }
            return null;
        }

        /**
         * SipariÅŸ durumu sorgulama
         */
        async function checkOrderStatus(orderId) {
            try {
                console.log('ğŸ” SipariÅŸ sorgulanÄ±yor:', orderId);
                
                const response = await fetch(`${API_BASE}/orders/${orderId}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
                
                if (response.ok) {
                    const order = await response.json();
                    
                    // KullanÄ±cÄ± kontrolÃ¼
                    if (order.user_id !== currentUser.id) {
                        return {
                            success: false,
                            message: `âŒ Bu sipariÅŸe eriÅŸim yetkiniz yok (SipariÅŸ #${orderId})`
                        };
                    }
                    
                    // Restoran kontrolÃ¼
                    if (order.restaurant_id !== parseInt(currentRestaurantId)) {
                        return {
                            success: false,
                            message: `âŒ Bu sipariÅŸ baÅŸka bir restorana ait (SipariÅŸ #${orderId})`
                        };
                    }
                    
                    const statusText = getStatusText(order.status);
                    
                    let orderDetails = `ğŸ“¦ SipariÅŸ #${orderId}\n`;
                    orderDetails += `ğŸ”¥ Durum: ${statusText}\n`;
                    orderDetails += `ğŸ’° Toplam: ${order.total_price}â‚º\n`;
                    orderDetails += `ğŸ“… Tarih: ${new Date(order.created_at).toLocaleString('tr-TR')}\n`;
                    orderDetails += `ğŸ“ Adres: ${order.delivery_address}\n`;
                    
                    if (order.items && order.items.length > 0) {
                        orderDetails += `\nğŸ“‹ SipariÅŸ Ä°Ã§eriÄŸi:\n`;
                        order.items.forEach(item => {
                            orderDetails += `â€¢ ${item.item_name || item.menu_name} x${item.quantity} - ${item.price * item.quantity}â‚º\n`;
                        });
                    }
                    
                    return { success: true, message: orderDetails };
                } else if (response.status === 403) {
                    return {
                        success: false,
                        message: `âŒ Bu sipariÅŸe eriÅŸim yetkiniz yok (SipariÅŸ #${orderId})`
                    };
                } else if (response.status === 404) {
                    return {
                        success: false,
                        message: `âŒ SipariÅŸ #${orderId} bulunamadÄ±`
                    };
                } else {
                    return {
                        success: false,
                        message: 'âŒ SipariÅŸ sorgulanÄ±rken hata oluÅŸtu'
                    };
                }
            } catch (error) {
                console.error('âŒ SipariÅŸ sorgulama hatasÄ±:', error);
                return {
                    success: false,
                    message: 'âŒ SipariÅŸ sorgulanÄ±rken hata oluÅŸtu'
                };
            }
        }

        /**
         * SipariÅŸ durumu metni
         */
        function getStatusText(status) {
            const statusStr = String(status).toLowerCase();
            switch(statusStr) {
                case 'created': return 'SipariÅŸ AlÄ±ndÄ±';
                case 'paid': return 'Ã–deme YapÄ±ldÄ±';
                case 'preparing': return 'HazÄ±rlanÄ±yor';
                case 'delivering': return 'Yolda';
                case 'delivered': return 'Teslim Edildi';
                case 'cancelled': return 'Ä°ptal Edildi';
                default: return 'Bilinmeyen Durum';
            }
        }

        /**
         * SipariÅŸ oluÅŸturma - Onay sistemi ile
         */
        async function createOrder() {
            try {
                if (cart.length === 0) {
                    return { success: false, message: 'ğŸ›’ Sepetiniz boÅŸ! Ã–nce Ã¼rÃ¼n ekleyin.' };
                }
                
                const totalAmount = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
                
                // Wallet kontrolÃ¼
                const walletResponse = await fetch(`${API_BASE}/wallet/${currentUser.username}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
                
                if (walletResponse.ok) {
                    const walletData = await walletResponse.json();
                    if (walletData.balance < totalAmount) {
                        return {
                            success: false,
                            message: `ğŸ’³ Yetersiz bakiye! Gerekli: ${totalAmount}â‚º, Mevcut: ${walletData.balance}â‚º`
                        };
                    }
                } else {
                    return { success: false, message: 'ğŸ’³ Bakiye kontrolÃ¼ yapÄ±lamadÄ±!' };
                }
                
                // Onay iste
                return {
                    success: true,
                    message: `ğŸ“‹ SipariÅŸ Ã–zeti:\n\n${cart.map((item, index) => `${index + 1}. ${item.name} x${item.quantity} - ${item.price * item.quantity}â‚º`).join('\n')}\n\nğŸ’° Toplam: ${totalAmount}â‚º\n\nBu sipariÅŸi onaylÄ±yor musunuz? "Evet onaylÄ±yorum" veya "HayÄ±r" diyebilirsiniz.`,
                    needsConfirmation: true
                };
                
            } catch (error) {
                console.error('âŒ SipariÅŸ hatasÄ±:', error);
                return { success: false, message: 'âŒ SipariÅŸ oluÅŸturulurken hata oluÅŸtu!' };
            }
        }
        
        /**
         * SipariÅŸ onaylama
         */
        async function confirmOrder() {
            try {
                const totalAmount = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
                
                const orderData = {
                    customer_name: currentUser.username || 'MÃ¼ÅŸteri',
                    customer_phone: currentUser.phone || 'BelirtilmemiÅŸ',
                    delivery_address: currentUser.address || 'BelirtilmemiÅŸ',
                    restaurant_id: parseInt(currentRestaurantId),
                    items: cart.map(item => ({
                        item_id: item.type === 'item' ? item.id : null,
                        menu_id: item.type === 'menu' ? item.id : null,
                        quantity: item.quantity
                    }))
                };
                
                const response = await fetch(`${API_BASE}/orders`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(orderData)
            });
            
            if (response.ok) {
                const order = await response.json();
                    cart = []; // Sepeti temizle
                    console.log('ğŸ“¦ SipariÅŸ oluÅŸturuldu:', order);
                    return {
                        success: true,
                        message: `ğŸ‰ SipariÅŸiniz oluÅŸturuldu!\nğŸ“¦ SipariÅŸ No: ${order.order_number || order.id}\nğŸ’° Toplam: ${totalAmount}â‚º\nâ±ï¸ Tahmini teslimat: 30-45 dakika`
                    };
            } else {
                const error = await response.json();
                    return {
                        success: false,
                        message: error.detail || 'âŒ SipariÅŸ oluÅŸturulamadÄ±!'
                    };
                }
                
            } catch (error) {
                console.error('âŒ SipariÅŸ hatasÄ±:', error);
                return { success: false, message: 'âŒ SipariÅŸ oluÅŸturulurken hata oluÅŸtu!' };
            }
        }

        /**
         * SipariÅŸ durumu sorgulama
         */
        async function getOrderStatus() {
            try {
                // Son sipariÅŸi al
                const response = await fetch(`${API_BASE}/orders/user/${currentUser.id}/restaurant/${currentRestaurantId}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
                
                if (!response.ok) {
                    return { success: false, message: 'âŒ SipariÅŸ bilgileri alÄ±namadÄ±!' };
                }
                
                const orders = await response.json();
                
                if (orders.length === 0) {
                    return { success: false, message: 'ğŸ“¦ HenÃ¼z sipariÅŸiniz bulunmuyor.' };
                }
                
                // En son sipariÅŸi al
                const latestOrder = orders[0];
                
                let statusText = '';
                switch (latestOrder.status) {
                    case 'pending':
                        statusText = 'â³ Beklemede';
                        break;
                    case 'confirmed':
                        statusText = 'âœ… OnaylandÄ±';
                        break;
                    case 'preparing':
                        statusText = 'ğŸ‘¨â€ğŸ³ HazÄ±rlanÄ±yor';
                        break;
                    case 'ready':
                        statusText = 'ğŸ½ï¸ HazÄ±r';
                        break;
                    case 'on_the_way':
                        statusText = 'ğŸšš Yolda';
                        break;
                    case 'delivered':
                        statusText = 'âœ… Teslim Edildi';
                        break;
                    case 'cancelled':
                        statusText = 'âŒ Ä°ptal Edildi';
                        break;
                    default:
                        statusText = 'â“ Bilinmeyen';
                }
                
                const orderDate = new Date(latestOrder.created_at).toLocaleString('tr-TR');
                
                let message = `ğŸ“¦ SipariÅŸ #${latestOrder.id}\n`;
                message += `ğŸ”¥ Durum: ${statusText}\n`;
                message += `ğŸ’° Toplam: ${latestOrder.total_amount}â‚º\n`;
                message += `ğŸ“… Tarih: ${orderDate}\n`;
                message += `ğŸ“ Adres: ${latestOrder.delivery_address}\n\n`;
                message += `ğŸ“‹ SipariÅŸ Ä°Ã§eriÄŸi:\n`;
                
                // SipariÅŸ iÃ§eriÄŸini ekle
                if (latestOrder.items && latestOrder.items.length > 0) {
                    latestOrder.items.forEach((item, index) => {
                        const itemName = item.item_name || item.menu_name || 'Bilinmeyen ÃœrÃ¼n';
                        const quantity = item.quantity || 1;
                        const price = item.price || 0;
                        message += `â€¢ ${itemName} x${quantity} - ${price * quantity}â‚º\n`;
                    });
                }
                
                return { success: true, message: message };
                
            } catch (error) {
                console.error('âŒ SipariÅŸ durumu hatasÄ±:', error);
                return { success: false, message: 'âŒ SipariÅŸ durumu sorgulanÄ±rken hata oluÅŸtu!' };
            }
        }

        /**
         * Realtime API'ye mesaj gÃ¶nder
         */
        function sendToRealtime(message) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const messageData = {
                    type: 'conversation.item.create',
                    restaurant_id: currentRestaurantId,
                    user_id: currentUser?.id,
                    username: currentUser?.username,  // Username bilgisini ekle
                    item: {
                        type: 'message',
                        role: 'user',
                        content: [{ type: 'input_text', text: message }]
                    }
                };
                
                websocket.send(JSON.stringify(messageData));
                showTyping();
            } else {
                console.warn('âš ï¸ WebSocket baÄŸlÄ± deÄŸil - Fallback sistemi devreye girer');
                showStatus('BaÄŸlantÄ± yok', 'error');
            }
        }

        /**
         * Son kullanÄ±cÄ± mesajÄ±nÄ± al
         */
        function getLastUserMessage() {
            const messages = document.querySelectorAll('.message.user .message-content');
            if (messages.length > 0) {
                return messages[messages.length - 1].textContent;
            }
            return '';
        }

        /**
         * OpenAI Function Call System - Sadece OpenAI kullanÄ±lÄ±r
         */
        async function handleOpenAIFunctionCall(message) {
            console.log('ğŸ¤– OpenAI Function Call iÃ§in:', message);
            
            const lowerMsg = message.toLowerCase();
            let result;
            
            // MenÃ¼
            if (lowerMsg.includes('menÃ¼') || lowerMsg.includes('menu')) {
                result = await getMenuItems();
            }
            // Sepete ekleme  
            else if (lowerMsg.includes('sepete') || lowerMsg.includes('ekle')) {
                const itemName = extractItemName(message);
                const quantity = extractQuantity(message);
                result = await smartAddToCart(itemName, message);
            }
            // Sepet gÃ¶ster
            else if (lowerMsg.includes('sepet')) {
                result = await showCart();
            }
            // SipariÅŸ durumu
            else if (lowerMsg.includes('sipariÅŸ') && (lowerMsg.includes('durum') || lowerMsg.includes('nerede'))) {
                const orderId = extractOrderId(message);
                if (orderId) {
                    result = await checkOrderStatus(orderId);
                } else {
                    result = await getOrderStatus();
                }
            }
            // VarsayÄ±lan yanÄ±t
            else {
                result = await generateSmartResponse(message);
            }
            
            addMessage('assistant', result.message || result);
            speak(result.message || result);
        }

        /**
         * Speech Recognition sistemi
         */
        function startSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                showAlert('TarayÄ±cÄ±nÄ±z konuÅŸma tanÄ±mayÄ± desteklemiyor. Chrome kullanÄ±n.', 'error');
                return;
            }

            if (isSpeaking) {
                showStatus('Asistan konuÅŸuyor, bekleyin...', 'info');
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'tr-TR';

            recognition.onstart = () => {
                console.log('ğŸ¤ Mikrofon baÅŸladÄ±');
                isListening = true;
                voiceButton.innerHTML = '<span>ğŸ›‘</span><span>Dinleniyor...</span>';
                voiceButton.className = 'voice-btn stop';
                showStatus('Dinleniyor...', 'info');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                console.log('ğŸ“ AlgÄ±lanan:', transcript);
                
                addMessage('user', transcript);
                
                // Function call sistemi kullanÄ±lÄ±yor - direkt iÅŸleme yok
                
                // Realtime API'ye gÃ¶nder
                sendToRealtime(transcript);
            };

            recognition.onerror = (event) => {
                console.error('âŒ Speech error:', event.error);
                showStatus('Ses tanÄ±ma hatasÄ±', 'error');
                resetVoiceButton();
            };

            recognition.onend = () => {
                console.log('ğŸ”‡ Mikrofon kapandÄ±');
                resetVoiceButton();
            };

            try {
                recognition.start();
            } catch (error) {
                console.error('âŒ Mikrofon baÅŸlatma hatasÄ±:', error);
                showStatus('Mikrofon aÃ§Ä±lamadÄ±', 'error');
            }
        }

        function resetVoiceButton() {
            isListening = false;
            voiceButton.innerHTML = '<span>ğŸ¤</span><span>KonuÅŸmaya BaÅŸla</span>';
            voiceButton.className = 'voice-btn start';
            showStatus('HazÄ±r', 'info');
        }
        
        /**
         * Event listeners
         */
        voiceButton.addEventListener('click', () => {
            console.log('ğŸ”˜ Voice button - listening:', isListening, 'speaking:', isSpeaking);
            
            if (isListening) {
                recognition.stop();
            } else if (isSpeaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                showStatus('HazÄ±r', 'info');
            } else {
                startSpeechRecognition();
            }
        });

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // MenÃ¼ gÃ¶sterme fonksiyonu
        function displayMenu(menuData) {
            console.log('ğŸ“‹ MenÃ¼ gÃ¶steriliyor:', menuData);
            
            // MenÃ¼ data kontrolÃ¼
            if (!menuData || !Array.isArray(menuData)) {
                console.log('âŒ GeÃ§ersiz menÃ¼ verisi:', menuData);
                return;
            }
            
            let menuText = 'ğŸ½ï¸ **RESTORAN MENÃœSÃœ**\n\n';
            
            menuData.forEach(category => {
                if (category && category.name && Array.isArray(category.items)) {
                    menuText += `**${category.name}:**\n`;
                    category.items.forEach(item => {
                        if (item && item.name && item.price) {
                            menuText += `â€¢ ${item.name}: ${item.price} TL\n`;
                        }
                    });
                    menuText += '\n';
                }
            });
            
            addMessage('assistant', menuText);
            speak(menuText);
        }
        
        // Sepet gÃ¶sterme fonksiyonu
        function displayCart(cartData) {
            console.log('ğŸ›’ Sepet gÃ¶steriliyor:', cartData);
            
            // Sepet data kontrolÃ¼
            if (!cartData || !Array.isArray(cartData) || cartData.length === 0) {
                console.log('ğŸ“‹ Sepet boÅŸ');
                return;
            }
            
            let cartText = 'ğŸ›’ **SEPET Ä°Ã‡ERÄ°ÄÄ°**\n\n';
            let total = 0;
            
            cartData.forEach((item, index) => {
                if (item && item.item_name && item.quantity) {
                    const itemTotal = item.price ? item.price * item.quantity : 0;
                    total += itemTotal;
                    
                    cartText += `${index + 1}. ${item.item_name}\n`;
                    cartText += `   Adet: ${item.quantity}\n`;
                    if (item.price) {
                        cartText += `   Birim Fiyat: ${item.price} TL\n`;
                        cartText += `   Toplam: ${itemTotal} TL\n`;
                    }
                    cartText += '\n';
                }
            });
            
            if (total > 0) {
                cartText += `ğŸ’° **GENEL TOPLAM: ${total} TL**`;
            }
            
            addMessage('assistant', cartText);
            speak(cartText);
        }
        
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            addMessage('user', message);
            messageInput.value = '';
            
            // MenÃ¼ direkt kontrolÃ¼
            if (message.toLowerCase().includes('menÃ¼')) {
                setTimeout(async () => {
                    const result = await getMenuItems();
                    addMessage('assistant', result.message);
                    speak(result.message);
                }, 200);
                return;
            }
            
            // Realtime API'ye gÃ¶nder
            sendToRealtime(message);
        }

        /**
         * Mesaj ekleme sistemi
         */
        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const time = new Date().toLocaleTimeString('tr-TR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Content kontrolÃ¼
            if (!content) {
                content = 'Mesaj iÃ§eriÄŸi bulunamadÄ±';
            }
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div>${content.replace(/\n/g, '<br>')}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /**
         * Sayfa yÃ¼kleme
         */
        window.onload = async () => {
            console.log('ğŸš€ Sesli Asistan baÅŸlatÄ±lÄ±yor...');
            
            if (!authToken) {
                showAlert('GiriÅŸ yapmanÄ±z gerekiyor!', 'error');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return;
            }

            await fetchCurrentUser();
            if (currentUser && currentRestaurantId) {
                await fetchSelectedRestaurant(currentRestaurantId);
                if (selectedRestaurant) {
                    connectWebSocket();
                    console.log('âœ… Sistem hazÄ±r!');
                }
            }

        // HoÅŸ geldin mesajÄ±nÄ±n zamanÄ±nÄ± ayarla
        document.getElementById('welcomeTime').textContent = new Date().toLocaleTimeString('tr-TR');
        };
    </script>
</body>
</html>